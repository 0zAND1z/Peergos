<!doctype html>
<html>
<head>
</head>
    
<body>
<h1>RSA examples</h1>
<script type="text/javascript" src="lib/cryptico.min.js"></script>
<script type="text/javascript" src="lib/jsencrypt.min.js"></script>
<script type="text/javascript" src="lib/scrypt.js"></script>
<script>
function generate() {
    console.log("generating..");
    var bits = parseInt(document.getElementById("bits").value);
    var username = document.getElementById("username").value;
    var password = document.getElementById("password").value;
    var desiredBytes = 64;
    var n = 16384;//32768;
    var r = 8, p = 1;
    var scrypt = scrypt_module_factory();
    var dt = new Date();
    var time = -(dt.getTime());
    var pbkdf_bytes = scrypt.crypto_scrypt(scrypt.encode_utf8(password),
					      scrypt.encode_utf8(username),
					      n, r, p, desiredBytes);
    var keypair = cryptico.generateRSAKey(scrypt.to_hex(pbkdf_bytes), bits);
    var pubString = "-----BEGIN PUBLIC KEY-----\n" + wordwrap(getPublicBaseKeyB64(keypair)) + "\n-----END PUBLIC KEY-----";
    var privString = "-----BEGIN RSA PRIVATE KEY-----\n" + wordwrap(getPrivateBaseKeyB64(keypair)) + "\n-----END RSA PRIVATE KEY-----";

    /*var crypt = new JSEncrypt({default_key_size: bits});
      var async = false;
      var dt = new Date();
      var time = -(dt.getTime());
      if (async) {
        $('#time-report').text('.');
        var load = setInterval(function () {
          var text = document.getElementById("status").innerHTML;
          document.getElementById("status").innerHTML =+ '.';
        }, 500);
        crypt.getKey(function () {
          clearInterval(load);
          dt = new Date();
          time += (dt.getTime());
          document.getElementById("status").innerHTML = ('Generated in ' + time + ' ms');
          document.getElementById("private").value = crypt.getPrivateKey();
          document.getElementById("public").value = crypt.getPublicKey();
        });
        return;
      }
      crypt.getKey();*/
      dt = new Date();
      time += (dt.getTime());
      document.getElementById("status").innerHTML = ('Generated in ' + time + ' ms');
      document.getElementById("private").value = privString;//crypt.getPrivateKey();
      document.getElementById("public").value = pubString;//crypt.getPublicKey();
}
var encrypted;
function encrypt() {
    console.log("encrypting..");
    var encrypt = new JSEncrypt();
    encrypt.setPublicKey(document.getElementById("public").value);
    encrypted = encrypt.encrypt(document.getElementById("data").value);
    document.getElementById("encrypted").value = encrypted;
}
function decrypt() {
    console.log("decrypting..");
    var decrypt = new JSEncrypt();
    decrypt.setPrivateKey(document.getElementById("private").value);
    var decrypted = decrypt.decrypt(encrypted);
    document.getElementById("decrypted").value = decrypted;
}

getPublicBaseKey = function (pair) {
  var options = {
    'array': [
      new KJUR.asn1.DERObjectIdentifier({'oid': '1.2.840.113549.1.1.1'}), //RSA Encryption pkcs #1 oid
      new KJUR.asn1.DERNull()
    ]
  };
  var first_sequence = new KJUR.asn1.DERSequence(options);

  options = {
    'array': [
      new KJUR.asn1.DERInteger({'bigint': pair.n}),
      new KJUR.asn1.DERInteger({'int': pair.e})
    ]
  };
  var second_sequence = new KJUR.asn1.DERSequence(options);

  options = {
    'hex': '00' + second_sequence.getEncodedHex()
  };
  var bit_string = new KJUR.asn1.DERBitString(options);

  options = {
    'array': [
      first_sequence,
      bit_string
    ]
  };
  var seq = new KJUR.asn1.DERSequence(options);
  return seq.getEncodedHex();
};

function getPrivateBaseKey(pair) {
  var options = {
    'array': [
      new KJUR.asn1.DERInteger({'int': 0}),
      new KJUR.asn1.DERInteger({'bigint': pair.n}),
      new KJUR.asn1.DERInteger({'int': pair.e}),
      new KJUR.asn1.DERInteger({'bigint': pair.d}),
      new KJUR.asn1.DERInteger({'bigint': pair.p}),
      new KJUR.asn1.DERInteger({'bigint': pair.q}),
      new KJUR.asn1.DERInteger({'bigint': pair.dmp1}),
      new KJUR.asn1.DERInteger({'bigint': pair.dmq1}),
      new KJUR.asn1.DERInteger({'bigint': pair.coeff})
    ]
  };
  var seq = new KJUR.asn1.DERSequence(options);
  return seq.getEncodedHex();
};

getPublicBaseKeyB64 = function (pair) {
  return hex2b64(getPublicBaseKey(pair));
};

function getPrivateBaseKeyB64(pair) {
  return hex2b64(getPrivateBaseKey(pair));
};

var b64map="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";
var b64pad="=";
function hex2b64(h) {
  var i;
  var c;
  var ret = "";
  for(i = 0; i+3 <= h.length; i+=3) {
    c = parseInt(h.substring(i,i+3),16);
    ret += b64map.charAt(c >> 6) + b64map.charAt(c & 63);
  }
  if(i+1 == h.length) {
    c = parseInt(h.substring(i,i+1),16);
    ret += b64map.charAt(c << 2);
  }
  else if(i+2 == h.length) {
    c = parseInt(h.substring(i,i+2),16);
    ret += b64map.charAt(c >> 2) + b64map.charAt((c & 3) << 4);
  }
  while((ret.length & 3) > 0) ret += b64pad;
  return ret;
}

/**
 * wrap the string in block of width chars. The default value for rsa keys is 64
 * characters.
 * @param {string} str the pem encoded string without header and footer
 * @param {Number} [width=64] - the length the string has to be wrapped at
 * @returns {string}
 * @private
 */
function wordwrap(str, width) {
  width = width || 64;
  if (!str) {
    return str;
  }
  var regex = '(.{1,' + width + '})( +|$\n?)|(.{1,' + width + '})';
  return str.match(RegExp(regex, 'g')).join('\n');
};
</script>

<label>Username:</label>
<textarea id="username" size="20">Bob</textarea><br/>
<label>Password:</label>
<textarea id="password" size="20">password</textarea><br/>
<select id="bits">
  <option value="1024">1024</option>
  <option value="2048">2048</option>
  <option value="4096">4096</option>
</select>
<br/>
<button id="genButton" onclick="generate();">Generate keys</button>

<p/>
<textarea id="public" placeholder="Public Key" cols="65" rows="10">-----BEGIN PUBLIC KEY-----
MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDlOJu6TyygqxfWT7eLtGDwajtN
FOb9I5XRb6khyfD1Yt3YiCgQWMNW649887VGJiGr/L5i2osbl8C9+WJTeucF+S76
xFxdU6jE0NQ+Z+zEdhUTooNRaY5nZiu5PgDB0ED/ZKBUSLKL7eibMxZtMlUDHjm4
gwQco1KRMDSmXSMkDwIDAQAB
-----END PUBLIC KEY-----</textarea><br/>
<textarea id="private" placeholder="Private Key" cols="65" rows="15">-----BEGIN RSA PRIVATE KEY-----
MIICXQIBAAKBgQDlOJu6TyygqxfWT7eLtGDwajtNFOb9I5XRb6khyfD1Yt3YiCgQ
WMNW649887VGJiGr/L5i2osbl8C9+WJTeucF+S76xFxdU6jE0NQ+Z+zEdhUTooNR
aY5nZiu5PgDB0ED/ZKBUSLKL7eibMxZtMlUDHjm4gwQco1KRMDSmXSMkDwIDAQAB
AoGAfY9LpnuWK5Bs50UVep5c93SJdUi82u7yMx4iHFMc/Z2hfenfYEzu+57fI4fv
xTQ//5DbzRR/XKb8ulNv6+CHyPF31xk7YOBfkGI8qjLoq06V+FyBfDSwL8KbLyeH
m7KUZnLNQbk8yGLzB3iYKkRHlmUanQGaNMIJziWOkN+N9dECQQD0ONYRNZeuM8zd
8XJTSdcIX4a3gy3GGCJxOzv16XHxD03GW6UNLmfPwenKu+cdrQeaqEixrCejXdAF
z/7+BSMpAkEA8EaSOeP5Xr3ZrbiKzi6TGMwHMvC7HdJxaBJbVRfApFrE0/mPwmP5
rN7QwjrMY+0+AbXcm8mRQyQ1+IGEembsdwJBAN6az8Rv7QnD/YBvi52POIlRSSIM
V7SwWvSK4WSMnGb1ZBbhgdg57DXaspcwHsFV7hByQ5BvMtIduHcT14ECfcECQATe
aTgjFnqE/lQ22Rk0eGaYO80cc643BXVGafNfd9fcvwBMnk0iGX0XRsOozVt5Azil
psLBYuApa66NcVHJpCECQQDTjI2AQhFc1yRnCU/YgDnSpJVm1nASoRUnU8Jfm3Oz
uku7JUXcVpt08DFSceCEX9unCuMcT72rAQlLpdZir876
-----END RSA PRIVATE KEY-----</textarea><br/>
<p/>
<textarea id="data" placeholder="Data to encrypt" cols="65" rows="5"></textarea><br/>
<button id="encryptButton" onclick="encrypt();">Encrypt data</button>
<p/>
<textarea id="encrypted" placeholder="Encrypted data" cols="65" rows="5"></textarea><br/>
<button id="decryptButton" onclick="decrypt();">Decrypt data</button>
<p/>
<textarea id="decrypted" placeholder="Decrypted data" cols="65" rows="5"></textarea><br/>
<div id="status"></div>


</body>
</html>
