<!doctype html>
<html>
<head>
</head>
    
<body>
<h1>Crypto examples</h1>
<script type="text/javascript" src="lib/scrypt.js"></script>
<script type="text/javascript" src="lib/jquery-2.1.3.min.js"></script>
<script type="text/javascript" src="lib/blake2s.js"></script>
<script type="text/javascript" src="lib/nacl.js"></script>
<script type="text/javascript" src="lib/api.js"></script>
<script>
function unsignResult(err, literals) {
    if (err != null) {
        return console.log("Problem: " + err);
    } else {
        console.log("Unsigned message" + literals[0].toString());
        var ds = km = null;
        ds = literals[0].get_data_signer();
        if (ds) { km = ds.get_key_manager(); }
        if (km) {
            console.log("Signed by PGP fingerprint: "+ km.get_pgp_fingerprint().toString('hex'));
        }
    }
}

function signResult(user) {
    return function (err, result_string, result_buffer) {
        console.log("Signature: " + result_buffer);
        var hash = user.hash(result_buffer);
        console.log("Hash("+hash.length+"): " + hash);
        user.unsignMessage(result_buffer, unsignResult);
    }
}

function decryptResult(user) {
    return function(err, literals) {
        if (err != null) {
            return console.log("Problem: " + err);
        } else {
            console.log("Decrypted message: " + literals[0].toString());
            var ds = km = null;
            ds = literals[0].get_data_signer();
            if (ds) { km = ds.get_key_manager(); }
            if (km) {
                console.log("Signed by PGP fingerprint");
                console.log(km.get_pgp_fingerprint().toString('hex'));
            }
            user.signMessage(literals[0], signResult(user));
        }
    };
       }

function encryptResult(user) {
    return function (err, result_string, result_buffer) {
        console.log("Cipher Text: " + result_buffer);
        user.decryptMessage(result_buffer, decryptResult(user));
    }
}

function genresult(pair) {
    document.getElementById("public").value = nacl.util.encodeBase64(pair.publicKey);
    document.getElementById("private").value = nacl.util.encodeBase64(pair.secretKey);
    var input = nacl.util.decodeUTF8(document.getElementById("data").value);
    var nonce = nacl.randomBytes(24);
    var cipher = nacl.box(input, nonce, pair.publicKey, pair.secretKey);
    document.getElementById("encrypted").value = nacl.util.encodeBase64(cipher);
    var clear = nacl.box.open(cipher, nonce, pair.publicKey, pair.secretKey);
    document.getElementById("decrypted").value = nacl.util.encodeUTF8(clear);
}
function generate() {
    console.log("generating..");
    var username = document.getElementById("username").value;
    var password = document.getElementById("password").value;
    
    generateKeyPair("fred", "pass", genresult);
}
function encrypt() {
    console.log("encrypting..");
    document.getElementById("encrypted").value = encryptStringToHex(document.getElementById("data").value, 
        document.getElementById("public").value);
}
function decrypt() {
    console.log("decrypting..");
    document.getElementById("decrypted").value = decryptHexToString(document.getElementById("encrypted").value, 
        document.getElementById("private").value);
}
</script>

<label>Username:</label>
<textarea id="username" size="20">user</textarea><br/>
<label>Password:</label>
<textarea id="password" size="20">pass</textarea><br/>
<br/>
<button id="genButton" onclick="generate();">Generate keys</button>

<p/>
<textarea id="public" placeholder="Public Key" cols="65" rows="10"></textarea><br/>
<p/>
<textarea id="private" placeholder="Private Key" cols="65" rows="10"></textarea><br/>
<p/>
<textarea id="data" cols="65" rows="5">G'day mate!</textarea><br/>
<button id="encryptButton" onclick="encrypt();">Encrypt data</button>
<p/>
<textarea id="encrypted" placeholder="Encrypted data" cols="65" rows="5"></textarea><br/>
<button id="decryptButton" onclick="decrypt();">Decrypt data</button>
<p/>
<textarea id="decrypted" placeholder="Decrypted data" cols="65" rows="5"></textarea><br/>
<div id="status"></div>


</body>
</html>
